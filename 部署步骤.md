# Dashy Cloudflare éƒ¨ç½²æ­¥éª¤

## âœ… å·²å®Œæˆé…ç½®

å‰ç«¯ä»£ç å·²ç»é…ç½®å¥½ï¼Œå‡†å¤‡ä¸Šä¼ åˆ° GitHubã€‚é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

- **Worker URL**: `https://dashy-worker.zhongweizi1108.workers.dev`
- **Pages åŸŸå**: `https://dashy-8ke.pages.dev`
- **API Token**: æš‚æœªè®¾ç½®ï¼ˆä»»ä½•äººéƒ½å¯ä»¥ä¿®æ”¹é…ç½®ï¼Œå»ºè®®åç»­æ·»åŠ ï¼‰

---

## ğŸ“ æ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…

### ç¬¬ä¸€æ­¥ï¼šæ¨é€ä»£ç åˆ° GitHub

```bash
git add .
git commit -m "æ·»åŠ  Cloudflare Workers é…ç½®æŒä¹…åŒ–æ”¯æŒ"
git push origin master
```

æ¨é€åï¼ŒCloudflare Pages ä¼šè‡ªåŠ¨é‡æ–°æ„å»ºå’Œéƒ¨ç½²ã€‚

---

### ç¬¬äºŒæ­¥ï¼šé…ç½® Cloudflare Worker

#### 1ï¸âƒ£ åˆ›å»º KV å‘½åç©ºé—´

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. è¿›å…¥ **Workers & Pages** > **KV**
3. ç‚¹å‡» **Create namespace**
4. å‘½åä¸ºï¼š`DASHY_CONFIG`
5. ç‚¹å‡» **Add**

#### 2ï¸âƒ£ ç¡®è®¤ Worker å·²å­˜åœ¨

è®¿é—®æ‚¨çš„ Worker ç®¡ç†é¡µé¢ï¼Œç¡®è®¤ `dashy-worker` å·²ç»å­˜åœ¨ã€‚
å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆåˆ›å»ºï¼š

1. è¿›å…¥ **Workers & Pages**
2. ç‚¹å‡» **Create application** > **Create Worker**
3. å‘½åä¸º `dashy-worker`
4. ç‚¹å‡» **Deploy**

#### 3ï¸âƒ£ æ›´æ–° Worker ä»£ç 

1. åœ¨ Worker åˆ—è¡¨ä¸­ï¼Œç‚¹å‡» `dashy-worker`
2. ç‚¹å‡» **Quick edit**
3. åˆ é™¤æ‰€æœ‰é»˜è®¤ä»£ç 
4. æ‰“å¼€é¡¹ç›®ä¸­çš„ `cloudflare-worker.js` æ–‡ä»¶
5. **å¤åˆ¶å…¨éƒ¨å†…å®¹**ç²˜è´´åˆ° Worker ç¼–è¾‘å™¨
6. ç‚¹å‡» **Save and Deploy**

#### 4ï¸âƒ£ ç»‘å®š KV å‘½åç©ºé—´

1. åœ¨ Worker é¡µé¢ï¼Œè¿›å…¥ **Settings** > **Variables**
2. æ‰¾åˆ° **KV Namespace Bindings** éƒ¨åˆ†
3. ç‚¹å‡» **Add binding**
4. å¡«å†™ï¼š
   - **Variable name**: `DASHY_CONFIG`ï¼ˆå¿…é¡»æ˜¯è¿™ä¸ªåç§°ï¼‰
   - **KV namespace**: é€‰æ‹©åˆšæ‰åˆ›å»ºçš„ `DASHY_CONFIG`
5. ç‚¹å‡» **Save**

#### 5ï¸âƒ£ æµ‹è¯• Workerï¼ˆå¯é€‰ï¼‰

åœ¨æµè§ˆå™¨è®¿é—®ï¼š
```
https://dashy-worker.zhongweizi1108.workers.dev/api/health
```

åº”è¯¥è¿”å›ï¼š
```json
{
  "status": "ok",
  "timestamp": "2026-01-19T...",
  "kvAvailable": true
}
```

å¦‚æœ `kvAvailable` æ˜¯ `false`ï¼Œè¯´æ˜ KV ç»‘å®šæœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç¬¬ 4 æ­¥ã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–é…ç½®

ç­‰å¾… Cloudflare Pages æ„å»ºå®Œæˆåï¼ˆçº¦ 2-5 åˆ†é’Ÿï¼‰ï¼š

#### æ–¹æ³•ä¸€ï¼šé€šè¿‡æµè§ˆå™¨ï¼ˆæ¨èï¼‰

1. è®¿é—®æ‚¨çš„ Dashy ç«™ç‚¹ï¼š`https://dashy-8ke.pages.dev`
2. æŒ‰ `F12` æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° **Console** æ ‡ç­¾
4. ç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```javascript
// è¯»å–é»˜è®¤é…ç½®å¹¶ä¿å­˜åˆ° Worker
fetch('/conf.yml')
  .then(r => r.text())
  .then(config => {
    console.log('é…ç½®å¤§å°:', config.length, 'å­—èŠ‚');
    return window.CloudflareConfigAdapter.saveConfig(config);
  })
  .then(result => {
    console.log('âœ… é…ç½®å·²æˆåŠŸä¿å­˜åˆ° Cloudflare KV!');
    console.log(result);
  })
  .catch(err => {
    console.error('âŒ ä¿å­˜å¤±è´¥:', err);
  });
```

#### æ–¹æ³•äºŒï¼šé€šè¿‡ APIï¼ˆå¦‚æœæ–¹æ³•ä¸€å¤±è´¥ï¼‰

ä½¿ç”¨ `curl` å‘½ä»¤ï¼ˆåœ¨æœ¬åœ°ç»ˆç«¯æ‰§è¡Œï¼‰ï¼š

```bash
curl -X POST https://dashy-worker.zhongweizi1108.workers.dev/api/config \
  -H "Content-Type: application/x-yaml" \
  --data-binary @public/conf.yml
```

---

### ç¬¬å››æ­¥ï¼šéªŒè¯åŠŸèƒ½

#### æµ‹è¯•é…ç½®åŠ è½½

1. åˆ·æ–° Dashy é¡µé¢ï¼ˆCtrl+Shift+R ç¡¬åˆ·æ–°ï¼‰
2. åœ¨æµè§ˆå™¨æ§åˆ¶å°åº”è¯¥çœ‹åˆ°ï¼š
   ```
   [Cloudflare Adapter] Cloudflare é…ç½®é€‚é…å™¨å·²åŠ è½½
   [Cloudflare Adapter] Worker URL: https://dashy-worker.zhongweizi1108.workers.dev
   [Cloudflare Adapter] API Token å·²é…ç½®: å¦
   [Cloudflare Adapter] æ­£åœ¨ä» Worker è·å–é…ç½®...
   [Cloudflare Adapter] æˆåŠŸä» Worker è·å–é…ç½®ï¼ˆå¤§å°ï¼šxxx å­—èŠ‚ï¼‰
   ```

#### æµ‹è¯•é…ç½®ä¿å­˜

1. åœ¨ Dashy ç•Œé¢ä¸­ï¼Œç‚¹å‡»å³ä¸Šè§’çš„è®¾ç½®å›¾æ ‡
2. ä¿®æ”¹ä»»ä½•é…ç½®ï¼ˆä¾‹å¦‚æ·»åŠ ä¸€ä¸ªæ–°é“¾æ¥æˆ–ä¿®æ”¹æ ‡é¢˜ï¼‰
3. ç‚¹å‡» **ä¿å­˜é…ç½®**
4. åˆ·æ–°é¡µé¢ï¼Œæ£€æŸ¥ä¿®æ”¹æ˜¯å¦ä¿ç•™

âœ… å¦‚æœä¿®æ”¹è¢«ä¿ç•™ï¼Œè¯´æ˜é…ç½®æˆåŠŸï¼

---

## ğŸ” è°ƒè¯•å·¥å…·

### åœ¨æµè§ˆå™¨æ§åˆ¶å°ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è°ƒè¯•ï¼š

```javascript
// æŸ¥çœ‹å½“å‰é…ç½®
window.CloudflareConfigAdapter.getConfig().then(console.log);

// æŸ¥çœ‹é…ç½®å…ƒä¿¡æ¯
window.CloudflareConfigAdapter.getMeta().then(console.log);

// æ¸…é™¤ç¼“å­˜ï¼ˆå¦‚æœé…ç½®æ²¡æ›´æ–°ï¼‰
window.CloudflareConfigAdapter.clearCache();

// å¯ç”¨/ç¦ç”¨è°ƒè¯•æ—¥å¿—
window.CloudflareConfigAdapter.setDebug(true);  // å¯ç”¨
window.CloudflareConfigAdapter.setDebug(false); // ç¦ç”¨
```

### æµ‹è¯• Worker APIï¼š

```javascript
// å¥åº·æ£€æŸ¥
fetch('https://dashy-worker.zhongweizi1108.workers.dev/api/health')
  .then(r => r.json())
  .then(console.log);

// è·å–é…ç½®
fetch('https://dashy-worker.zhongweizi1108.workers.dev/api/config')
  .then(r => r.text())
  .then(console.log);

// è·å–å…ƒä¿¡æ¯
fetch('https://dashy-worker.zhongweizi1108.workers.dev/api/config/meta')
  .then(r => r.json())
  .then(console.log);
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Worker è¿”å› 404

**åŸå› **: Worker æœªæ­£ç¡®éƒ¨ç½²æˆ– URL é”™è¯¯

**è§£å†³**:
1. æ£€æŸ¥ Worker åç§°æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ Worker å·²éƒ¨ç½²æˆåŠŸ
3. æµ‹è¯•è®¿é—® `/api/health` ç«¯ç‚¹

### é—®é¢˜ 2: ä¿å­˜é…ç½®å¤±è´¥ï¼Œæç¤º CORS é”™è¯¯

**åŸå› **: CORS é…ç½®ä¸æ­£ç¡®

**è§£å†³**:
1. ç¡®è®¤ `cloudflare-worker.js` ä¸­çš„ `ALLOWED_ORIGINS` åŒ…å« `https://dashy-8ke.pages.dev`
2. é‡æ–°éƒ¨ç½² Worker
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°

### é—®é¢˜ 3: æç¤º "kvAvailable: false"

**åŸå› **: KV å‘½åç©ºé—´æœªæ­£ç¡®ç»‘å®š

**è§£å†³**:
1. æ£€æŸ¥ Worker è®¾ç½®ä¸­çš„ KV Namespace Bindings
2. ç¡®è®¤å˜é‡åæ˜¯ `DASHY_CONFIG`ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
3. ç¡®è®¤é€‰æ‹©äº†æ­£ç¡®çš„ KV å‘½åç©ºé—´

### é—®é¢˜ 4: é…ç½®ä¿®æ”¹ååˆ·æ–°é¡µé¢è¿˜æ˜¯æ—§çš„

**åŸå› **: æµè§ˆå™¨æˆ–é€‚é…å™¨ç¼“å­˜

**è§£å†³**:
```javascript
// æ¸…é™¤é€‚é…å™¨ç¼“å­˜
window.CloudflareConfigAdapter.clearCache();
// ç„¶åç¡¬åˆ·æ–°é¡µé¢
```

### é—®é¢˜ 5: æ‰¾ä¸åˆ° window.CloudflareConfigAdapter

**åŸå› **: é€‚é…å™¨è„šæœ¬æœªåŠ è½½æˆ–åŠ è½½å¤±è´¥

**è§£å†³**:
1. ç¡®è®¤ `public/index.html` ä¸­åŒ…å«äº† `<script src="<%= BASE_URL %>cloudflare-config-adapter.js"></script>`
2. ç¡®è®¤ `public/cloudflare-config-adapter.js` æ–‡ä»¶å­˜åœ¨
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript é”™è¯¯
4. é‡æ–°æ„å»ºå’Œéƒ¨ç½²é¡¹ç›®

---

## ğŸ”’ åç»­å®‰å…¨åŠ å›ºï¼ˆå¯é€‰ï¼‰

ç›®å‰æœªè®¾ç½® API Tokenï¼Œä»»ä½•çŸ¥é“ Worker URL çš„äººéƒ½å¯ä»¥ä¿®æ”¹æ‚¨çš„é…ç½®ã€‚

### æ·»åŠ  API Token ä¿æŠ¤ï¼š

#### 1. ç”Ÿæˆå¼ºå¯†ç 

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆéšæœºå¯†ç ï¼š
```bash
# Linux/Mac
openssl rand -base64 32

# æˆ–åœ¨æµè§ˆå™¨æ§åˆ¶å°
btoa(Array.from(crypto.getRandomValues(new Uint8Array(32)), b => String.fromCharCode(b)).join(''))
```

ä¾‹å¦‚ï¼š`dsKp8vN2mQ7xR4fT9hL3wC6gB1nM5sA0`

#### 2. åœ¨ Worker ä¸­è®¾ç½®ç¯å¢ƒå˜é‡

1. è¿›å…¥ Worker è®¾ç½® > **Variables**
2. åœ¨ **Environment Variables** éƒ¨åˆ†ç‚¹å‡» **Add variable**
3. å¡«å†™ï¼š
   - **Variable name**: `API_TOKEN`
   - **Value**: åˆšæ‰ç”Ÿæˆçš„å¯†ç 
   - å‹¾é€‰ **Encrypt**
4. ç‚¹å‡» **Save**

#### 3. æ›´æ–°å‰ç«¯é…ç½®

ç¼–è¾‘ `public/cloudflare-config-adapter.js`ï¼Œæ‰¾åˆ°ï¼š

```javascript
API_TOKEN: '', // æš‚æœªè®¾ç½® API Token
```

æ”¹ä¸ºï¼š

```javascript
API_TOKEN: 'dsKp8vN2mQ7xR4fT9hL3wC6gB1nM5sA0', // æ›¿æ¢ä¸ºæ‚¨çš„å¯†ç 
```

#### 4. é‡æ–°éƒ¨ç½²

```bash
git add public/cloudflare-config-adapter.js
git commit -m "æ·»åŠ  API Token ä¿æŠ¤"
git push origin master
```

---

## ğŸ“Š ä½¿ç”¨é™åˆ¶ï¼ˆCloudflare å…è´¹å¥—é¤ï¼‰

- **Workers**: 100,000 æ¬¡è¯·æ±‚/å¤©
- **KV è¯»å–**: 100,000 æ¬¡/å¤©
- **KV å†™å…¥**: 1,000 æ¬¡/å¤©
- **KV å­˜å‚¨**: 1 GB

å¯¹äºä¸ªäººä½¿ç”¨å®Œå…¨è¶³å¤Ÿï¼

---

## ğŸ‰ å®Œæˆï¼

é…ç½®å®Œæˆåï¼Œæ‚¨å°±å¯ä»¥ï¼š

âœ… åœ¨ä»»ä½•è®¾å¤‡è®¿é—® Dashy
âœ… åœ¨ç•Œé¢ä¸­ä¿®æ”¹é…ç½®
âœ… é…ç½®è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯
âœ… åˆ·æ–°é¡µé¢åé…ç½®ä¿ç•™

äº«å—æ‚¨çš„è‡ªæ‰˜ç®¡ä»ªè¡¨æ¿å§ï¼
